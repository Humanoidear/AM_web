---
import { contentfulClient } from "../../../lib/contentful";
import { documentToHtmlString } from "@contentful/rich-text-html-renderer";
import { documentToPlainTextString } from "@contentful/rich-text-plain-text-renderer";
import type { work } from "../../../lib/contentful";
import BaseHead from "../../../components/BaseHead.astro";
import Header from "../../../components/Header.astro";
import Footer from "../../../components/Footer.astro";
import i18next, { t, changeLanguage } from "i18next";
import { SITE_TITLE } from "../../../consts";

changeLanguage("ca");

export async function getStaticPaths() {
    const { items } = await contentfulClient.getEntries<work>({
        content_type: "work",
    });
    const pages = items.map((item) => ({
        params: { slug: item.fields.slug },
        props: {
            title: item.fields.title,
            content: item.fields.content,
            year: item.fields.year,
            type: item.fields.type,
            services: item.fields.services,
            preview: item.fields.preview,
            heroImage: item.fields.heroImage,
        },
    }));
    return pages;
}
const { content, title, year, type, services, heroImage } = Astro.props;
let options = {
    renderNode: {
        "embedded-asset-block": (node: any) => `<img class="img-fluid" src="${node.data.target.fields.file.url}"/>`,
    },
};
let parsedSEOContent = documentToPlainTextString(content);
if (parsedSEOContent.length > 60) {
    parsedSEOContent = parsedSEOContent.slice(0, 160) + "...";
}
let bodyHTML = content ? documentToHtmlString(content, options) : "";
function parseLocalizedContent(html) {
    const regex = /<p>&lt;begin-localization=&quot;(.*?)&quot;&gt;<\/p>(.*?)<p>&lt;end-localization=&quot;\1&quot;&gt;<\/p>/gs;
    let match;
    const localizedContent = [];
    while ((match = regex.exec(html)) !== null) {
        localizedContent.push({
            lang: match[1],
            content: match[2].trim(),
        });
    }
    return localizedContent;
}
const localizedContentArray = parseLocalizedContent(bodyHTML);
const currentLanguage = i18next.language;
const defaultLanguage = "en";
const localizedContent = localizedContentArray.find(item => item.lang === currentLanguage);
const defaultContent = localizedContentArray.find(item => item.lang === defaultLanguage);
bodyHTML = localizedContent?.content || defaultContent?.content || bodyHTML;
---

<html lang="en">
  <head>
    <BaseHead
      title={`${title} | ${t("header.work")} | ${SITE_TITLE}`}
      description={`${type}\nServices: ${Array.isArray(services) && services.map((service) => " " + service)}\nYear: ${year}\n\n${parsedSEOContent}`}
      image={(heroImage as any)?.fields?.file?.url}
    />
  </head>

  <body>
    <Header work={` / ${title} `} />
    <main class="flex flex-col items-center">
      <div class="w-full">
        <div class="flex items-end justify-end rounded-none">
          {
            heroImage && (
              <div
                class="expand w-[95%] max-w-[1200px] h-[400px] relative"
                style={`background-size:cover; background-position:center; background-image: url('${(heroImage as any)?.fields?.file?.url}')`}
                transition:name={`work-title-${title}-image`}
              />
            )
          }
        </div>
        <div class="flex items-center justify-center">
          <div
            class="top-6 w-[95%] max-w-[1300px] flex sm:flex-row flex-col items-start justify-between gap-5 relative"
          >
            <img
              class="w-[700px] -translate-x-[150px] -translate-y-[350px] rotate-90 opacity-60 z-0 absolute"
              src="/img/blob-1.webp"
              transition:name={`work-title-${title}-blob`}
            />
            <h3
              class="max-w-[400px] font-[MGNHumble] text-white text-6xl z-10 relative"
              transition:name={`work-title-${title}`}
            >
              {title}
            </h3>
            <p
              class="font-semibold text-white text-2xl"
              transition:name={`work-title-${title}-type`}
            >
              {type}
            </p>
            <ul>
              <p class="opacity-60">Services</p>
              {
                Array.isArray(services) &&
                  services.map((service) => (
                    <li class="font-semibold text-white text-2xl">{service}</li>
                  ))
              }
            </ul>
            <div transition:name={`work-title-${title}-year`}>
              <p class="opacity-60">Year</p>
              <p class="font-semibold text-white text-2xl">{year}</p>
            </div>
          </div>
        </div>
      </div>
      <article class="mt-14 w-[98%] max-w-[1200px] text-white z-10 relative">
        <div class="prose">
          <div class="title"></div>
          <div set:html={bodyHTML} />
        </div>
      </article>
    </main>
    <Footer />
  </body>
</html>

<style>
  .expand {
    animation: auto linear expand both;
    animation-timeline: view();
    animation-range: exit;
  }
  @keyframes expand {
    0% {
      opacity: 1;
      transform: translate(0, 0);
      filter: grayscale(0) blur(0);
    }
    100% {
      opacity: 0;
      transform: translate(0, 100px);
      filter: grayscale(1) blur(5px);
    }
  }
</style>
